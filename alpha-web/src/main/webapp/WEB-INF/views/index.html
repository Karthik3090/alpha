<html>
  <head>
    <title>AlphaTeam</title>
    <style>
      #page_header {
        height: 0%;
      }
      
      #map {
        height: 100%;
      }

      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <script src="http://code.jquery.com/jquery-1.10.2.js"
	type="text/javascript"></script>
  </head>
  <body>
  	<div id="page_header"></div>
    <div id="map"></div>
    <script>
    
    window.RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;   //compatibility for firefox and chrome
    var pc = new RTCPeerConnection({iceServers:[]}), noop = function(){};      
    pc.createDataChannel("");    //create a bogus data channel
    pc.createOffer(pc.setLocalDescription.bind(pc), noop);    // create offer and set local description
    pc.onicecandidate = function(ice){  //listen for candidate events
        if(!ice || !ice.candidate || !ice.candidate.candidate)  return;
        window.myIP = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate)[1];
       
        pc.onicecandidate = noop;
    };
    
    var map_icon = 'https://cdn1.iconfinder.com/data/icons/transportation-vehicles-2/128/car-front-32.png';
	  var all_markers= [];
      
       function auto_update(){
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
        	  
        	  for(i=0; i<all_markers.length;++i){
        		  all_markers[i].setMap(null);
        	  }
        	  
              var pos = {
                      lat: position.coords.latitude,
                      lng: position.coords.longitude
                    };
                    
            map.setCenter(pos);
           
      	   $.ajax({
     		   url: "api/driver/saveDetails",
     		   data: {
     			   my_ip: myIP,
     			   lat : pos.lat,
     			   lng : pos.lng
     		   }
     		 });
                 
      	   
    	   $.ajax({
     		   url: "api/driver/findAll",
     		   success: function(others_pos) {
     	            for(i=0;i < others_pos.length; ++i){
     	                var marker = new google.maps.Marker({
     	                    position: {lat:parseFloat(others_pos[i].lat), lng:parseFloat(others_pos[i].lng)},
     	                    map: map,
     	                    icon : map_icon
     	                  });	
     	                
     	                all_markers.push(marker);
     	            }
     		   }
     	      });
            
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        }
      }
       
       function initMap() {
    	   window.map = new google.maps.Map(document.getElementById('map'), {
               center: {lat: 52.3105419, lng: 4.7660857},
               zoom: 15,
               mapTypeControlOptions: {
            	      mapTypeIds: []
            	    },
               mapTypeId: google.maps.MapTypeId.ROADMAP
             });
    	   setInterval(auto_update, 5000);
       }

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBEJ4eLPCqz-8LDVW8GXWnvuky8ZjxH52M&callback=initMap">
    </script>
  </body>
</html>